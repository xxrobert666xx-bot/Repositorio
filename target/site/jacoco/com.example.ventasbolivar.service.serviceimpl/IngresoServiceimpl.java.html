<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="es"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>IngresoServiceimpl.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">ventas_bolivar</a> &gt; <a href="index.source.html" class="el_package">com.example.ventasbolivar.service.serviceimpl</a> &gt; <span class="el_source">IngresoServiceimpl.java</span></div><h1>IngresoServiceimpl.java</h1><pre class="source lang-java linenums">package com.example.ventasbolivar.service.serviceimpl;

import com.example.ventasbolivar.model.dto.DetalleIngresoRequest;
import com.example.ventasbolivar.model.dto.DetalleIngresoResponse;
import com.example.ventasbolivar.model.dto.IngresoRequest;
import com.example.ventasbolivar.model.dto.IngresoResponse;
import com.example.ventasbolivar.model.entity.Articulo;
import com.example.ventasbolivar.model.entity.DetalleIngreso;
import com.example.ventasbolivar.model.entity.Ingreso;
import com.example.ventasbolivar.repository.ArticuloRepository;
import com.example.ventasbolivar.repository.DetalleIngresoRepository;
import com.example.ventasbolivar.repository.IngresoRepository;
import com.example.ventasbolivar.service.IngresoService;
import java.time.LocalDateTime;
import java.util.ArrayList;
import java.util.List;
import java.util.stream.Collectors;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.stereotype.Service;

/**
 * IngresoServiceImpl.
 */
@Service
public class IngresoServiceimpl implements IngresoService {

<span class="fc" id="L28">  private static final Logger logger = LoggerFactory.getLogger(IngresoServiceimpl.class);</span>

  private final IngresoRepository ingresoRepository;
  private final DetalleIngresoRepository detalleRepository;
  private final ArticuloRepository articuloRepository;

  /**
   * IngresoServiceImpl.
   */
  public IngresoServiceimpl(
      IngresoRepository ingresoRepository,
      DetalleIngresoRepository detalleRepository,
<span class="fc" id="L40">      ArticuloRepository articuloRepository) {</span>

<span class="fc" id="L42">    this.ingresoRepository = ingresoRepository;</span>
<span class="fc" id="L43">    this.detalleRepository = detalleRepository;</span>
<span class="fc" id="L44">    this.articuloRepository = articuloRepository;</span>
<span class="fc" id="L45">  }</span>

  @Override
  public IngresoResponse registrarIngreso(IngresoRequest request) {

<span class="fc" id="L50">    logger.info(&quot;Registrando ingreso proveedor={} usuario={} total={}&quot;,</span>
<span class="fc" id="L51">        request.getIdproveedor(), request.getIdusuario(), request.getTotalcompra());</span>

<span class="fc" id="L53">    Ingreso ingreso = new Ingreso();</span>
<span class="fc" id="L54">    ingreso.setIdproveedor(request.getIdproveedor());</span>
<span class="fc" id="L55">    ingreso.setIdusuario(request.getIdusuario());</span>
<span class="fc" id="L56">    ingreso.setTipoComprobante(request.getTipoComprobante());</span>
<span class="fc" id="L57">    ingreso.setSerieComprobante(request.getSerieComprobante());</span>
<span class="fc" id="L58">    ingreso.setNumComprobante(request.getNumComprobante());</span>
<span class="fc" id="L59">    ingreso.setFechahora(LocalDateTime.now());</span>
<span class="fc" id="L60">    ingreso.setImpuesto(request.getImpuesto());</span>
<span class="fc" id="L61">    ingreso.setTotalcompra(request.getTotalcompra());</span>
<span class="fc" id="L62">    ingreso.setEstado(&quot;Aceptado&quot;);</span>

<span class="fc" id="L64">    ingreso.setDetalles(new ArrayList&lt;&gt;());</span>

<span class="fc" id="L66">    ingreso = ingresoRepository.save(ingreso);</span>
<span class="fc" id="L67">    logger.debug(&quot;Ingreso guardado con ID={}&quot;, ingreso.getIdingreso());</span>

<span class="fc bfc" id="L69" title="All 2 branches covered.">    for (DetalleIngresoRequest detReq : request.getDetalles()) {</span>

<span class="fc" id="L71">      logger.debug(&quot;Procesando detalle articulo={} cantidad={}&quot;,</span>
<span class="fc" id="L72">          detReq.getIdarticulo(), detReq.getCantidad());</span>

<span class="fc" id="L74">      DetalleIngreso det = new DetalleIngreso();</span>
<span class="fc" id="L75">      det.setIngreso(ingreso);</span>
<span class="fc" id="L76">      det.setIdarticulo(detReq.getIdarticulo());</span>
<span class="fc" id="L77">      det.setCantidad(detReq.getCantidad());</span>
<span class="fc" id="L78">      det.setPrecioCompra(detReq.getPrecioCompra());</span>
<span class="fc" id="L79">      det.setPrecioVenta(detReq.getPrecioVenta());</span>

<span class="fc" id="L81">      Articulo articulo = articuloRepository.findById(detReq.getIdarticulo())</span>
<span class="fc" id="L82">          .orElseThrow(() -&gt; {</span>
<span class="nc" id="L83">            logger.error(&quot;Artículo no encontrado {}&quot;, detReq.getIdarticulo());</span>
<span class="nc" id="L84">            return new RuntimeException(&quot;Artículo no encontrado&quot;);</span>
          });

<span class="fc" id="L87">      detalleRepository.save(det);</span>
<span class="fc" id="L88">      ingreso.getDetalles().add(det);</span>

<span class="fc" id="L90">      articulo.setStock(articulo.getStock() + detReq.getCantidad());</span>
<span class="fc" id="L91">      articuloRepository.save(articulo);</span>

<span class="fc" id="L93">      logger.debug(&quot;Stock actualizado articulo={} stock={}&quot;,</span>
<span class="fc" id="L94">          articulo.getId(), articulo.getStock());</span>
<span class="fc" id="L95">    }</span>

<span class="fc" id="L97">    logger.info(&quot;Ingreso {} registrado correctamente&quot;, ingreso.getIdingreso());</span>
<span class="fc" id="L98">    return entityToResponse(ingreso);</span>
  }

  @Override
  public List&lt;IngresoResponse&gt; listar() {
<span class="nc" id="L103">    logger.info(&quot;Listando ingresos&quot;);</span>
<span class="nc" id="L104">    return ingresoRepository.findAll()</span>
<span class="nc" id="L105">     .stream()</span>
<span class="nc" id="L106">     .map(this::entityToResponse)</span>
<span class="nc" id="L107">     .collect(Collectors.toList());</span>
  }

  @Override
  public IngresoResponse obtenerPorId(Integer id) {
<span class="fc" id="L112">    logger.info(&quot;Buscando ingreso ID={}&quot;, id);</span>

<span class="fc" id="L114">    Ingreso ingreso = ingresoRepository.findById(id)</span>
<span class="fc" id="L115">        .orElseThrow(() -&gt; {</span>
<span class="fc" id="L116">          logger.error(&quot;Ingreso no encontrado ID={}&quot;, id);</span>
<span class="fc" id="L117">          return new RuntimeException(&quot;Ingreso no encontrado&quot;);</span>
        });

<span class="fc" id="L120">    return entityToResponse(ingreso);</span>
  }

  @Override
  public IngresoResponse anularIngreso(Integer id) {

<span class="fc" id="L126">    logger.warn(&quot;Intentando anular ingreso ID={}&quot;, id);</span>

<span class="fc" id="L128">    Ingreso ingreso = ingresoRepository.findById(id)</span>
<span class="fc" id="L129">        .orElseThrow(() -&gt; {</span>
<span class="nc" id="L130">          logger.error(&quot;Ingreso no encontrado ID={}&quot;, id);</span>
<span class="nc" id="L131">          return new RuntimeException(&quot;Ingreso no encontrado&quot;);</span>
        });

<span class="pc bpc" id="L134" title="1 of 2 branches missed.">    if (ingreso.getEstado().equalsIgnoreCase(&quot;Anulado&quot;)) {</span>
<span class="nc" id="L135">      logger.warn(&quot;Ingreso ID={} ya estaba anulado&quot;, id);</span>
<span class="nc" id="L136">      throw new RuntimeException(&quot;El ingreso ya se encuentra anulado&quot;);</span>
    }

<span class="fc" id="L139">    ingreso.getDetalles().forEach(det -&gt; {</span>

<span class="fc" id="L141">      Articulo art = articuloRepository.findById(det.getIdarticulo())</span>
<span class="fc" id="L142">          .orElseThrow(() -&gt; {</span>
<span class="nc" id="L143">            logger.error(&quot;Artículo no encontrado {}&quot;, det.getIdarticulo());</span>
<span class="nc" id="L144">            return new RuntimeException(&quot;Artículo no encontrado&quot;);</span>
          });

<span class="fc" id="L147">      art.setStock(art.getStock() - det.getCantidad());</span>
<span class="fc" id="L148">      articuloRepository.save(art);</span>

<span class="fc" id="L150">      logger.debug(&quot;Revirtiendo stock articulo={} nuevoStock={}&quot;,</span>
<span class="fc" id="L151">          art.getId(), art.getStock());</span>
<span class="fc" id="L152">    });</span>

<span class="fc" id="L154">    ingreso.setEstado(&quot;Anulado&quot;);</span>
<span class="fc" id="L155">    ingresoRepository.save(ingreso);</span>

<span class="fc" id="L157">    logger.info(&quot;Ingreso ID={} anulado correctamente&quot;, id);</span>

<span class="fc" id="L159">    return entityToResponse(ingreso);</span>
  }

  private IngresoResponse entityToResponse(Ingreso ingreso) {
<span class="fc" id="L163">    IngresoResponse res = new IngresoResponse();</span>

<span class="fc" id="L165">    res.setIdingreso(ingreso.getIdingreso());</span>
<span class="fc" id="L166">    res.setIdproveedor(ingreso.getIdproveedor());</span>
<span class="fc" id="L167">    res.setIdusuario(ingreso.getIdusuario());</span>
<span class="fc" id="L168">    res.setTipoComprobante(ingreso.getTipoComprobante());</span>
<span class="fc" id="L169">    res.setSerieComprobante(ingreso.getSerieComprobante());</span>
<span class="fc" id="L170">    res.setNumComprobante(ingreso.getNumComprobante());</span>
<span class="fc" id="L171">    res.setFechahora(ingreso.getFechahora());</span>
<span class="fc" id="L172">    res.setImpuesto(ingreso.getImpuesto());</span>
<span class="fc" id="L173">    res.setTotalcompra(ingreso.getTotalcompra());</span>
<span class="fc" id="L174">    res.setEstado(ingreso.getEstado());</span>
<span class="fc" id="L175">    res.setDetalles(</span>
<span class="fc" id="L176">        ingreso.getDetalles().stream().map(det -&gt; {</span>
<span class="fc" id="L177">          DetalleIngresoResponse d = new DetalleIngresoResponse();</span>
<span class="fc" id="L178">          d.setIddetalleIngreso(det.getIddetalleIngreso());</span>
<span class="fc" id="L179">          d.setIdarticulo(det.getIdarticulo());</span>
<span class="fc" id="L180">          d.setCantidad(det.getCantidad());</span>
<span class="fc" id="L181">          d.setPrecioCompra(det.getPrecioCompra());</span>
<span class="fc" id="L182">          d.setPrecioVenta(det.getPrecioVenta());</span>
<span class="fc" id="L183">          return d;</span>
<span class="fc" id="L184">        }).collect(Collectors.toList())</span>
    );

<span class="fc" id="L187">    return res;</span>
  }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span></div></body></html>