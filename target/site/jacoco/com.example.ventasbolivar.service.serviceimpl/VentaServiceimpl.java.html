<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="es"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>VentaServiceimpl.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">ventas_bolivar</a> &gt; <a href="index.source.html" class="el_package">com.example.ventasbolivar.service.serviceimpl</a> &gt; <span class="el_source">VentaServiceimpl.java</span></div><h1>VentaServiceimpl.java</h1><pre class="source lang-java linenums">package com.example.ventasbolivar.service.serviceimpl;

import com.example.ventasbolivar.model.dto.ArticuloVentaResponse;
import com.example.ventasbolivar.model.dto.DetalleVentaResponse;
import com.example.ventasbolivar.model.dto.SelectOptionDto;
import com.example.ventasbolivar.model.dto.SerieNumeroResponse;
import com.example.ventasbolivar.model.dto.VentaRequest;
import com.example.ventasbolivar.model.dto.VentaResponse;
import com.example.ventasbolivar.model.entity.Articulo;
import com.example.ventasbolivar.model.entity.DetalleVenta;
import com.example.ventasbolivar.model.entity.Persona;
import com.example.ventasbolivar.model.entity.Usuario;
import com.example.ventasbolivar.model.entity.Venta;
import com.example.ventasbolivar.repository.ArticuloRepository;
import com.example.ventasbolivar.repository.DetalleVentaRepository;
import com.example.ventasbolivar.repository.PersonaRepository;
import com.example.ventasbolivar.repository.UsuarioRepository;
import com.example.ventasbolivar.repository.VentaRepository;
import com.example.ventasbolivar.service.VentaService;
import java.math.BigDecimal;
import java.time.LocalDateTime;
import java.util.List;
import java.util.NoSuchElementException;
import java.util.stream.Collectors;
import lombok.RequiredArgsConstructor;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;

/**
 * Servicio de ventas.
 */
@Service
@RequiredArgsConstructor
public class VentaServiceimpl implements VentaService {

<span class="fc" id="L38">  private static final Logger log = LoggerFactory.getLogger(VentaServiceimpl.class);</span>

  private final VentaRepository ventaRepo;
  private final DetalleVentaRepository detalleRepo;
  private final PersonaRepository personaRepo;
  private final UsuarioRepository usuarioRepo;
  private final ArticuloRepository articuloRepo;

  @Override
  public List&lt;VentaResponse&gt; listar() {
<span class="fc" id="L48">    log.info(&quot;Listando todas las ventas&quot;);</span>

<span class="fc" id="L50">    List&lt;VentaResponse&gt; lista = ventaRepo.findAll()</span>
<span class="fc" id="L51">        .stream().map(this::toResponse)</span>
<span class="fc" id="L52">        .collect(Collectors.toList());</span>

<span class="fc" id="L54">    log.info(&quot;Total ventas encontradas: {}&quot;, lista.size());</span>
<span class="fc" id="L55">    return lista;</span>
  }

  @Override
  public VentaResponse obtener(Integer id) {
<span class="fc" id="L60">    log.info(&quot;Obteniendo venta con ID {}&quot;, id);</span>

<span class="fc" id="L62">    return ventaRepo.findById(id)</span>
<span class="fc" id="L63">     .map(v -&gt; {</span>
<span class="fc" id="L64">       log.debug(&quot;Venta encontrada: Serie {} - Número {}&quot;,</span>
<span class="fc" id="L65">           v.getSerieComprobante(), v.getNumComprobante());</span>
<span class="fc" id="L66">       return toResponse(v);</span>
     })
<span class="fc" id="L68">     .orElseThrow(() -&gt; {</span>
<span class="fc" id="L69">       log.warn(&quot;Venta con ID {} no encontrada&quot;, id);</span>
<span class="fc" id="L70">       return new NoSuchElementException(&quot;Venta no encontrada&quot;);</span>
     });
  }

  @Override
  @Transactional
  public VentaResponse crear(VentaRequest req) {
<span class="fc" id="L77">    log.info(&quot;Creando nueva venta para cliente ID {} por usuario ID {}&quot;,</span>
<span class="fc" id="L78">        req.getIdCliente(), req.getIdUsuario());</span>

<span class="fc" id="L80">    Persona cliente = personaRepo.findById(req.getIdCliente())</span>
<span class="fc" id="L81">        .orElseThrow(() -&gt; {</span>
<span class="fc" id="L82">          log.warn(&quot;Cliente ID {} no encontrado&quot;, req.getIdCliente());</span>
<span class="fc" id="L83">          return new NoSuchElementException(&quot;Cliente no encontrado&quot;);</span>
        });

<span class="fc" id="L86">    Usuario usuario = usuarioRepo.findById(req.getIdUsuario())</span>
<span class="fc" id="L87">        .orElseThrow(() -&gt; {</span>
<span class="nc" id="L88">          log.warn(&quot;Usuario ID {} no encontrado&quot;, req.getIdUsuario());</span>
<span class="nc" id="L89">          return new NoSuchElementException(&quot;Usuario no encontrado&quot;);</span>
        });

<span class="fc" id="L92">    Venta v = new Venta();</span>
<span class="fc" id="L93">    v.setCliente(cliente);</span>
<span class="fc" id="L94">    v.setUsuario(usuario);</span>
<span class="fc" id="L95">    v.setTipoComprobante(req.getTipoComprobante());</span>
<span class="fc" id="L96">    v.setSerieComprobante(req.getSerieComprobante());</span>
<span class="fc" id="L97">    v.setNumComprobante(req.getNumComprobante());</span>
<span class="pc bpc" id="L98" title="1 of 2 branches missed.">    v.setFechaHora(req.getFechaHora() == null ? LocalDateTime.now() : req.getFechaHora());</span>
<span class="fc" id="L99">    v.setImpuesto(req.getImpuesto());</span>
<span class="fc" id="L100">    v.setTotalVenta(req.getTotalVenta());</span>
<span class="fc" id="L101">    v.setEstado(&quot;Aceptado&quot;);</span>

<span class="fc" id="L103">    Venta saved = ventaRepo.save(v);</span>
<span class="fc" id="L104">    log.info(&quot;Venta registrada con ID {}&quot;, saved.getId());</span>

<span class="fc" id="L106">    List&lt;DetalleVenta&gt; detalles = req.getDetalles().stream().map(dr -&gt; {</span>
<span class="fc" id="L107">      log.debug(&quot;Procesando detalle para artículo ID {}&quot;, dr.getIdArticulo());</span>

<span class="fc" id="L109">      Articulo art = articuloRepo.findById(dr.getIdArticulo())</span>
<span class="fc" id="L110">          .orElseThrow(() -&gt; {</span>
<span class="nc" id="L111">            log.warn(&quot;Artículo ID {} no encontrado&quot;, dr.getIdArticulo());</span>
<span class="nc" id="L112">            return new NoSuchElementException(&quot;Artículo no encontrado&quot;);</span>
          });

<span class="pc bpc" id="L115" title="1 of 2 branches missed.">      if (art.getStock() &lt; dr.getCantidad()) {</span>
<span class="nc" id="L116">        log.error(&quot;Stock insuficiente. Artículo {} - Stock actual: {}, solicitado: {}&quot;,</span>
<span class="nc" id="L117">            art.getId(), art.getStock(), dr.getCantidad());</span>
<span class="nc" id="L118">        throw new IllegalArgumentException(&quot;Stock insuficiente para el artículo id &quot; + art.getId());</span>
      }

<span class="fc" id="L121">      art.setStock(art.getStock() - dr.getCantidad());</span>
<span class="fc" id="L122">      articuloRepo.save(art);</span>
<span class="fc" id="L123">      log.debug(&quot;Stock actualizado. Artículo {} nuevo stock: {}&quot;, art.getId(), art.getStock());</span>

<span class="fc" id="L125">      DetalleVenta dv = new DetalleVenta();</span>
<span class="fc" id="L126">      dv.setVenta(saved);</span>
<span class="fc" id="L127">      dv.setArticulo(art);</span>
<span class="fc" id="L128">      dv.setCantidad(dr.getCantidad());</span>
<span class="fc" id="L129">      dv.setPrecioVenta(dr.getPrecioVenta());</span>
<span class="pc bpc" id="L130" title="1 of 2 branches missed.">      dv.setDescuento(dr.getDescuento() == null ? BigDecimal.ZERO : dr.getDescuento());</span>
<span class="fc" id="L131">      return dv;</span>
<span class="fc" id="L132">    }).collect(Collectors.toList());</span>

<span class="fc" id="L134">    detalleRepo.saveAll(detalles);</span>

<span class="fc" id="L136">    saved.setDetalles(detalles);</span>
<span class="fc" id="L137">    ventaRepo.save(saved);</span>

<span class="fc" id="L139">    log.info(&quot;Venta {} creada con {} detalles&quot;, saved.getId(), detalles.size());</span>

<span class="fc" id="L141">    return toResponse(saved);</span>
  }

  @Override
  @Transactional
  public VentaResponse anular(Integer id) {
<span class="fc" id="L147">    log.info(&quot;Anulando venta con ID {}&quot;, id);</span>

<span class="fc" id="L149">    Venta v = ventaRepo.findById(id)</span>
<span class="fc" id="L150">        .orElseThrow(() -&gt; {</span>
<span class="fc" id="L151">          log.warn(&quot;Venta con ID {} no encontrada para anular&quot;, id);</span>
<span class="fc" id="L152">          return new NoSuchElementException(&quot;Venta no encontrada&quot;);</span>
        });

<span class="fc" id="L155">    v.setEstado(&quot;Anulado&quot;);</span>
<span class="fc" id="L156">    ventaRepo.save(v);</span>

<span class="fc" id="L158">    log.info(&quot;Venta {} anulada correctamente&quot;, id);</span>
<span class="fc" id="L159">    return toResponse(v);</span>
  }

  @Override
  public List&lt;SelectOptionDto&gt; selectClientes() {
<span class="fc" id="L164">    log.info(&quot;Listando clientes para Select&quot;);</span>

<span class="fc" id="L166">    return personaRepo.findAll().stream()</span>
<span class="fc" id="L167">     .filter(p -&gt; &quot;Cliente&quot;.equalsIgnoreCase(p.getTipoPersona()))</span>
<span class="fc" id="L168">     .map(p -&gt; new SelectOptionDto(p.getId(), p.getNombre()))</span>
<span class="fc" id="L169">     .collect(Collectors.toList());</span>
  }

  @Override
  public List&lt;ArticuloVentaResponse&gt; listarArticulosActivosVenta() {
<span class="fc" id="L174">    log.info(&quot;Listando artículos activos para venta&quot;);</span>

<span class="fc" id="L176">    return articuloRepo.findAll().stream()</span>
<span class="pc bpc" id="L177" title="1 of 4 branches missed.">     .filter(a -&gt; a.getCondicion() != null &amp;&amp; a.getCondicion() == 1)</span>
<span class="fc" id="L178">     .map(a -&gt; new ArticuloVentaResponse(</span>
<span class="fc" id="L179">      a.getId(),</span>
<span class="fc" id="L180">      a.getNombre(),</span>
<span class="pc bpc" id="L181" title="1 of 2 branches missed.">      a.getCategoria() != null ? a.getCategoria().getNombre() : &quot;&quot;,</span>
<span class="fc" id="L182">      a.getCodigo(),</span>
<span class="fc" id="L183">      a.getStock(),</span>
<span class="fc" id="L184">      a.getPrecioVenta(),</span>
<span class="fc" id="L185">      0.0,</span>
<span class="fc" id="L186">      a.getImagen()</span>
     ))
<span class="fc" id="L188">     .collect(Collectors.toList());</span>
  }

  @Override
  public SerieNumeroResponse nextSerieNumero(String tipo) {
<span class="fc" id="L193">    log.info(&quot;Generando siguiente serie y número para comprobante tipo {}&quot;, tipo);</span>

<span class="pc bpc" id="L195" title="3 of 5 branches missed.">    String prefijo = switch (tipo == null ? &quot;Boleta&quot; : tipo) {</span>
<span class="nc" id="L196">      case &quot;Factura&quot; -&gt; &quot;F&quot;;</span>
<span class="nc" id="L197">      case &quot;Ticket&quot; -&gt; &quot;T&quot;;</span>
<span class="fc" id="L198">      default -&gt; &quot;B&quot;;</span>
    };

<span class="fc" id="L201">    String serieFinal = prefijo + &quot;V001&quot;;</span>
<span class="fc" id="L202">    Integer lastNum = ventaRepo.findMaxNumComprobanteBySerie(serieFinal);</span>

<span class="fc" id="L204">    log.debug(&quot;Último número encontrado para serie {}: {}&quot;, serieFinal, lastNum);</span>

<span class="pc bpc" id="L206" title="1 of 2 branches missed.">    String numero = lastNum == null ? &quot;000001&quot; : String.format(&quot;%06d&quot;, lastNum + 1);</span>

<span class="fc" id="L208">    return new SerieNumeroResponse(serieFinal, numero);</span>
  }

  @Override
  public List&lt;DetalleVentaResponse&gt; listarDetalle(Integer idVenta) {
<span class="fc" id="L213">    log.info(&quot;Listando detalles de venta ID {}&quot;, idVenta);</span>

<span class="fc" id="L215">    return detalleRepo.findByVentaId(idVenta)</span>
<span class="fc" id="L216">     .stream()</span>
<span class="fc" id="L217">     .map(d -&gt; new DetalleVentaResponse(</span>
<span class="fc" id="L218">      d.getId(),</span>
<span class="fc" id="L219">      d.getArticulo().getId(),</span>
<span class="fc" id="L220">      d.getArticulo().getNombre(),</span>
<span class="fc" id="L221">      d.getCantidad(),</span>
<span class="fc" id="L222">      d.getPrecioVenta(),</span>
<span class="fc" id="L223">      d.getDescuento()</span>
     ))
<span class="fc" id="L225">     .collect(Collectors.toList());</span>
  }

  /* Helpers */
  private VentaResponse toResponse(Venta v) {
<span class="fc" id="L230">    VentaResponse resp = new VentaResponse();</span>
<span class="fc" id="L231">    resp.setId(v.getId());</span>
<span class="pc bpc" id="L232" title="1 of 2 branches missed.">    resp.setIdCliente(v.getCliente() != null ? v.getCliente().getId() : null);</span>
<span class="pc bpc" id="L233" title="1 of 2 branches missed.">    resp.setNombreCliente(v.getCliente() != null ? v.getCliente().getNombre() : null);</span>
<span class="pc bpc" id="L234" title="1 of 2 branches missed.">    resp.setIdUsuario(v.getUsuario() != null ? v.getUsuario().getId() : null);</span>
<span class="fc" id="L235">    resp.setTipoComprobante(v.getTipoComprobante());</span>
<span class="fc" id="L236">    resp.setSerieComprobante(v.getSerieComprobante());</span>
<span class="fc" id="L237">    resp.setNumComprobante(v.getNumComprobante());</span>
<span class="fc" id="L238">    resp.setFechaHora(v.getFechaHora());</span>
<span class="fc" id="L239">    resp.setImpuesto(v.getImpuesto());</span>
<span class="fc" id="L240">    resp.setTotalVenta(v.getTotalVenta());</span>
<span class="fc" id="L241">    resp.setEstado(v.getEstado());</span>

<span class="fc bfc" id="L243" title="All 2 branches covered.">    if (v.getDetalles() != null) {</span>
<span class="fc" id="L244">      resp.setDetalles(v.getDetalles().stream()</span>
<span class="fc" id="L245">          .map(d -&gt; new DetalleVentaResponse(</span>
<span class="fc" id="L246">          d.getId(),</span>
<span class="fc" id="L247">          d.getArticulo().getId(),</span>
<span class="fc" id="L248">          d.getArticulo().getNombre(),</span>
<span class="fc" id="L249">          d.getCantidad(),</span>
<span class="fc" id="L250">          d.getPrecioVenta(),</span>
<span class="fc" id="L251">          d.getDescuento()</span>
       ))
<span class="fc" id="L253">          .collect(Collectors.toList()));</span>
    }
<span class="fc" id="L255">    return resp;</span>
  }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span></div></body></html>